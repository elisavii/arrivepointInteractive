<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Arrive Point</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: linear-gradient(135deg, #02080f, #040d17); 
            height: 100vh;
        }

        canvas { display: block; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 5px;
            display: none;
            pointer-events: none;
        }

        .hover-circle {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #83e349;
            border-radius: 50%;
            background: transparent;
            pointer-events: none;
            display: none;
            animation: pulse 1.2s infinite ease-in-out;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ffffff33;
            border-top-color: #85E34A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        #menu-container {
            position: fixed;
            top: 50%;
            right: -200px;
            width: 200px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px 0 0 10px;
            transform: translateY(-50%);
            transition: right 0.3s ease-in-out;
        }

        #menu-toggle {
            position: absolute;
            left: -40px;
            top: 10px;
            width: 40px;
            height: 40px;
            background: #83e349;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px 0 0 5px;
        }

        #menu-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #menu-content h3 {
            margin: 10px 0;
            font-size: 16px;
        }

        #menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        #menu-list li {
            padding: 8px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
            transition: background 0.3s;
        }

        #menu-list li:hover {
            background: #83e349;
            color: black;
        }

        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .tooltip { font-size: 16px; padding: 6px; }
            .hover-circle { width: 15px; height: 15px; }
        }

    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
    </div>
    <div id="tooltip" class="tooltip"></div>
    <div id="hover-circle" class="hover-circle"></div>

    <div id="menu-container">
        <button id="menu-toggle">â˜°</button>
        <div id="menu-content">
            <h3>Features</h3>
            <ul id="menu-list"></ul>
        </div>
    </div>    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <script>
        let scene, camera, renderer, controls, model;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const tooltip = document.getElementById('tooltip');
        const hoverCircle = document.getElementById('hover-circle');
        const clickableObjects = [];

        // scene setup
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 5, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.radius = 5;

        scene.add(directionalLight);

        // orbit controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 1;
        controls.maxDistance = 8;
        //for mobile
        controls.enablePan = false;
        controls.enableRotate = true;
        controls.enableZoom = true;


        // load model
        const loader = new THREE.GLTFLoader();
        let mixer;
        const animations = {};
        const animationStates = {};
        let morphMesh = null;

        loader.load(
            'arrivePoint0.gltf',
            (gltf) => {
                const model = gltf.scene;
                model.position.set(0, -2, 0);
                model.rotation.y = Math.PI - 1;
                scene.add(model);
                document.getElementById('loading').style.display = 'none';

                console.log("Debug: Listing all objects in model...");
                model.traverse((child) => {
                    console.log(`Object: ${child.name}, Type: ${child.type}`);
                    if (child.morphTargetDictionary) {
                        morphMesh = child;
                    }
                });

                mixer = new THREE.AnimationMixer(model);
                gltf.animations.forEach((clip) => {
                    const action = mixer.clipAction(clip);
                    action.setLoop(THREE.LoopOnce);
                    action.clampWhenFinished = true;
                    animations[clip.name] = action;
                    animationStates[clip.name] = false;
                });

                markClickableParts(model);
                populateMenu();
            },
            (xhr) => console.log(`${(xhr.loaded / xhr.total * 100).toFixed(2)}% loaded`),
            (error) => console.error('Model loading failed:', error)
        );

        // identify and store clickable parts
        function markClickableParts(model) {
            model.traverse((child) => {
                if (child.isMesh && child.name.startsWith("info_")) {
                    clickableObjects.push(child);
                    child.userData.info = `Details about ${child.name}`;
                }
            });
        }

        // handle hover
        window.addEventListener('mousemove', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true);

            hoverCircle.style.left = `${event.clientX - 10}px`;
            hoverCircle.style.top = `${event.clientY - 10}px`;
            hoverCircle.style.display = intersects.length > 0 ? 'block' : 'none';
        });

        // handle click
        window.addEventListener('click', (event) => {
            handleObjectClick(event);
        });

        function handleObjectClick(event, objectName = null) {
            if (!objectName) {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(clickableObjects, true);
                if (intersects.length === 0) return console.warn("No clickable object detected.");
                objectName = intersects[0].object.name;
            }

            console.log(`Clicked on object: ${objectName}`);
            toggleAnimation(objectName);
        }

        function toggleAnimation(objectName) {
            const animationName = objectName + "Action";
            if (!animations[animationName]) return console.error(`No animation found for ${objectName}`);

            const action = animations[animationName];
            const isForward = !animationStates[animationName];
            action.paused = false;
            action.timeScale = isForward ? 1 : -1;
            action.reset().play();
            animationStates[animationName] = isForward;

            if (isForward) {
                showObjectTooltip(objectName);
            }
        }

        function showObjectTooltip(objectName) {
            const object = clickableObjects.find(obj => obj.name === objectName);
            if (!object || !object.userData.info) return;
            
            const boundingBox = new THREE.Box3().setFromObject(object);
            const center = boundingBox.getCenter(new THREE.Vector3());
            const projected = center.clone().project(camera);
            
            const screenX = (projected.x * 0.5 + 0.5) * window.innerWidth;
            const screenY = (1 - (projected.y * 0.5 + 0.5)) * window.innerHeight;
            
            showTooltip(screenX, screenY, object.userData.info);
        }

        // populate menu
        function populateMenu() {
            const menuList = document.getElementById('menu-list');
            menuList.innerHTML = '';

            clickableObjects.forEach((object) => {
                const listItem = document.createElement('li');
                listItem.textContent = object.name.replace("info_", "");
                listItem.dataset.objectName = object.name;
                listItem.addEventListener('click', () => handleObjectClick(null, object.name));
                menuList.appendChild(listItem);
            });
        }

        // toggle menu
        const menuContainer = document.getElementById('menu-container');
        const menuToggle = document.getElementById('menu-toggle');
        menuToggle.addEventListener('click', () => {
            menuContainer.style.right = menuContainer.style.right === '-200px' ? '0px' : '-200px';
        });

        // tooltip display function
        function showTooltip(x, y, text) {
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y - 30}px`;
            tooltip.innerHTML = text;
            tooltip.style.display = 'block';
            clearTimeout(window.tooltipTimeout);
            window.tooltipTimeout = setTimeout(() => { tooltip.style.display = 'none'; }, 3000);
        }

        // handle window resize
        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });

        // render Loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (mixer) mixer.update(0.016);
            renderer.render(scene, camera);
        }
        animate();

    </script>
</body>
</html>
